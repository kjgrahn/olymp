#!/usr/bin/perl -w
#
# $Id: olymp,v 1.10 2006-02-02 19:53:58 grahn Exp $
# 

use strict;
use POSIX qw(strftime);
use vars qw($opt_e);
use Getopt::Std;

my %monthcodes = ("1" => 1, "2" => 2, "3" => 3,
		  "4" => 4, "5" => 5, "6" => 6,
		  "7" => 7, "8" => 8, "9" => 9,
		  "a" =>10, "b" =>11, "c" =>12);

getopts('e') or die;

while(my $file = shift) {

    my ($prefix, $year, $month, $day, $index);

    if($file =~ /(.*?)p([0-9abc])(\d{2})(\d{4})\.jpg/) {

	($prefix, $month, $day, $index) = ($1, $monthcodes{$2}, $3, $4);
	$year = 2006;
    }
    elsif($file =~ m|(.*?/)?(\d{2})(\d{2})(\d{2})\_(\d{2})\.jpg|) {

	($prefix, $year, $month, $day, $index) = ($1, 2000+$2, $3, $4, $5);
    }
    elsif($file =~ m|(.*?/)?(20\d{2})-(\d{2})-(\d{2})\_(\d{4})\.jpg|) {

	($prefix, $year, $month, $day, $index) = ($1, $2, $3, $4, $5);
    }
    else {
	next;
    }

    next if $month>12 or $day>31;
    next unless -e $file;

    # find its creation time

    my ($dev,$ino,$mode,$nlink,$uid,$gid,$rdev,$size,$atime,$mtime,$ctime) =
	stat $file
	    or die;

    my $date = sprintf "%04d-%02d-%02d", $year, $month, $day;

    # if it matches the date in the file name, we can trust the time, too
    my $hours = "00:00";
    $hours = strftime "%H:%M", localtime $mtime
	if (sprintf "%04d%02d%02d", $year, $month, $day)
	    eq (strftime "%Y%m%d", localtime $mtime);

    my  $new = sprintf "%s_%04d.jpg", $date, $index;
    print "$new\n";
    print "$date $hours\n\n";

    if(defined($opt_e)) {
	# we want to rename as well
	rename($file, "$prefix$new") unless -e "$prefix$new";
    }
}

__END__
